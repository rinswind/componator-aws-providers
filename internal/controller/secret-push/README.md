# Secret Push Handler

The `secret-push` handler generates secrets and pushes them to AWS Secrets Manager, designed to work with External Secrets Operator (ESO) for secret consumption.

## Overview

This handler eliminates the need for manual ESO Password generators and PushSecret resources by:
- Generating secrets via AWS Secrets Manager's native `GetRandomPassword` API
- Combining generated secrets with static values (supporting cross-component references)
- Storing secrets as flat JSON key-value pairs in AWS Secrets Manager
- Leaving structure templating to ESO when pulling secrets back

**Key Design:** No secret material is ever persisted in Kubernetes. Passwords are generated by AWS SM, combined with static values in handler memory, and pushed directly to AWS SM.

## Features

- **AWS-native generation**: Uses AWS Secrets Manager's cryptographically secure password generation
- **Flat key-value storage**: Stores secrets as simple JSON objects for ESO flexibility
- **Cross-component references**: Static fields support templating from other components
- **Lifecycle policies**: Control update and deletion behavior
- **No K8s persistence**: Zero secret material stored in Kubernetes resources

## Configuration

### Component Spec

```yaml
apiVersion: deployment-orchestrator.io/v1alpha1
kind: Component
metadata:
  name: app-credentials
spec:
  handler: secret-push
  config:
    # AWS Secrets Manager target
    region: us-east-1
    secretName: "myapp/prod/credentials"
    
    # Optional: KMS key for encryption
    kmsKeyId: "alias/myapp-secrets"
    
    # Flat field list - each has EITHER value OR generator
    fields:
      # Static fields (can use cross-component refs)
      username:
        value: "admin"
      email:
        value: "admin@example.com"
      db_host:
        value: "{{ .database.providerStatus.endpoint }}"
      
      # Generated fields (AWS GetRandomPassword)
      admin_password:
        generator:
          passwordLength: 32
          requireEachIncludedType: true
          excludePunctuation: false
      
      api_token:
        generator:
          passwordLength: 64
          excludePunctuation: true
    
    # Update policy
    updatePolicy: IfNotExists  # IfNotExists | AlwaysUpdate
    
    # Deletion policy
    deletionPolicy: Delete  # Delete | Retain
```

### Field Specification

Each field in `fields` must have **EXACTLY ONE** of:

#### Static Value
```yaml
username:
  value: "admin"
```
- Supports cross-component references: `value: "{{ .other_component.providerStatus.field }}"`
- Resolved by Composition Controller before handler sees it

#### Password Generator
```yaml
password:
  generator:
    passwordLength: 32                 # Required: 1-4096
    requireEachIncludedType: true      # Optional: require upper, lower, number, symbol
    excludePunctuation: false          # Optional: exclude punctuation
    excludeNumbers: false              # Optional: exclude numbers
    excludeLowercase: false            # Optional: exclude lowercase
    excludeUppercase: false            # Optional: exclude uppercase
    includeSpace: false                # Optional: include spaces
    excludeCharacters: "/@\""          # Optional: specific chars to exclude
```

### Policies

**Update Policy:**
- `IfNotExists` (default): Don't update if secret exists
- `AlwaysUpdate`: Regenerate and update on every reconciliation

**Deletion Policy:**
- `Delete` (default): Delete secret from AWS SM when Component is deleted
- `Retain`: Leave secret in AWS SM when Component is deleted

## Usage Example

### Replace ESO Boilerplate

**Before (3 resources):**
```yaml
# 1. Password Generator
- name: passwd_gen
  type: manifest
  config:
    manifests:
      - apiVersion: generators.external-secrets.io/v1alpha1
        kind: Password
        spec:
          length: 32

# 2. PushSecret
- name: creds_push
  type: manifest
  dependsOn: [passwd_gen]
  config:
    manifests:
      - apiVersion: external-secrets.io/v1alpha1
        kind: PushSecret
        spec:
          selector:
            generatorRef: ...
          template: ...

# 3. Pull back
- name: creds_pull
  type: manifest
  dependsOn: [creds_push]
  config:
    manifests:
      - apiVersion: external-secrets.io/v1beta1
        kind: ExternalSecret
        ...
```

**After (2 resources):**
```yaml
# 1. Push credentials
- name: app_credentials
  type: secret-push
  dependsOn:
    - database  # For endpoint reference
  config:
    region: us-east-1
    secretName: "myapp/prod/credentials"
    fields:
      username:
        value: "admin"
      password:
        generator:
          passwordLength: 32
          requireEachIncludedType: true
      db_host:
        value: "{{ .database.providerStatus.endpoint }}"

# 2. Pull back (ESO handles templating)
- name: creds_pull
  type: manifest
  dependsOn:
    - app_credentials
  config:
    manifests:
      - apiVersion: external-secrets.io/v1beta1
        kind: ExternalSecret
        metadata:
          name: app-credentials
          namespace: myapp
        spec:
          secretStoreRef:
            name: aws-secrets-manager
            kind: ClusterSecretStore
          target:
            name: app-credentials
            template:
              engineVersion: v2
              data:
                # ESO templates the flat secret
                app-username: "{{ .username }}"
                app-password: "{{ .password }}"
                db-config: |
                  {
                    "host": "{{ .db_host }}",
                    "user": "{{ .username }}"
                  }
          dataFrom:
            - extract:
                key: "{{ .app_credentials.providerStatus.secretPath }}"
```

## AWS Secrets Manager Output

The handler creates a **flat JSON structure** in AWS Secrets Manager:

```json
{
  "username": "admin",
  "password": "aB3$xY9!kL2@mN5#pQ7&",
  "email": "admin@example.com",
  "db_host": "db.us-east-1.rds.amazonaws.com",
  "api_token": "kj23h4kjh23k4jh23k4jh23kj4h23kj4h23kj4h23kj4h23kj4h"
}
```

ESO ExternalSecret handles any complex structure templating when pulling the secret.

## Component Status

```yaml
status:
  phase: Ready
  conditions:
    - type: SecretsGenerated
      status: "True"
      message: "Generated passwords via AWS GetRandomPassword"
    - type: SecretPushed
      status: "True"
      message: "Pushed to AWS Secrets Manager"
  providerStatus:
    secretArn: "arn:aws:secretsmanager:us-east-1:123456:secret:myapp/prod/credentials-AbCdEf"
    secretName: "myapp/prod/credentials"
    secretPath: "myapp/prod/credentials"  # For ESO reference
    versionId: "uuid-version-id"
    region: "us-east-1"
    lastSyncTime: "2025-10-21T10:30:00Z"
    fieldCount: 5
```

## IAM Permissions

The handler requires these IAM permissions:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:CreateSecret",
        "secretsmanager:UpdateSecret",
        "secretsmanager:DescribeSecret",
        "secretsmanager:DeleteSecret",
        "secretsmanager:GetRandomPassword"
      ],
      "Resource": "*"
    },
    {
      "Effect": "Allow",
      "Action": [
        "kms:Decrypt",
        "kms:GenerateDataKey"
      ],
      "Resource": "arn:aws:kms:*:*:key/*",
      "Condition": {
        "StringEquals": {
          "kms:ViaService": "secretsmanager.*.amazonaws.com"
        }
      }
    }
  ]
}
```

Configure via IRSA (IAM Roles for Service Accounts) on the handler pod.

## Security

- **No K8s persistence**: Passwords never stored in Kubernetes resources
- **AWS-native generation**: Cryptographically secure via AWS Secrets Manager
- **In-memory only**: Generated values exist only in handler memory during reconciliation
- **Immediate push**: Secrets pushed directly to AWS SM after generation
- **KMS encryption**: Optional customer-managed keys for encryption at rest
- **Audit trail**: AWS CloudTrail logs all Secrets Manager operations

## Comparison to ESO Approach

| Aspect | ESO (Password + PushSecret) | secret-push Handler |
|--------|----------------------------|---------------------|
| Resources needed | 3 (Password + PushSecret + ExternalSecret) | 2 (Component + ExternalSecret) |
| K8s secret persistence | No (with generatorRef) | No (in-memory only) |
| Password generation | ESO Password resource | AWS GetRandomPassword |
| Cross-component refs | Limited | Full support in static fields |
| JSON structure | ESO PushSecret template | ESO ExternalSecret template |
| Error visibility | Spread across 3 resources | Single Component status |

## Troubleshooting

### Secret not created
- Check IAM permissions for handler pod
- Verify AWS region configuration
- Check handler logs for AWS API errors

### Field validation errors
- Ensure each field has EXACTLY ONE of `value` or `generator`
- Validate `passwordLength` is between 1-4096
- Check `updatePolicy` and `deletionPolicy` values

### Cross-component reference not resolved
- Verify dependency component is in Ready phase
- Check dependency component has required `providerStatus` field
- Ensure `dependsOn` includes the referenced component

### Secret not updating
- Check `updatePolicy` - default is `IfNotExists`
- Change to `AlwaysUpdate` to force regeneration
- Delete and recreate Component to regenerate

## Integration with External Secrets Operator

This handler is designed to work seamlessly with ESO:

1. **secret-push** generates and pushes secrets to AWS SM
2. **ESO ClusterSecretStore** provides AWS SM access
3. **ESO ExternalSecret** pulls secrets and templates structure
4. Result: Kubernetes Secret with templated structure

This division allows:
- Handler handles generation and push (no K8s persistence)
- ESO handles pull and structure templating (its strength)
- Clean separation of concerns
